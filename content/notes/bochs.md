---
title: "Bochs"
date: 2023-07-17T11:01:58+08:00
draft: true
---

# bochs
- 计算机启动流程
    BIOS >> MBR >> loader >> kernel
    计算机上电后，es:ip被强制初始化为0xF000:0xFFF0，这就是计算机上电后的入口地址，也就是计算机上电后执行的第一条指令。
    BIOS的代码存放在地址为0xF0000～0xFFFEF的ROM中，入口地址存放的指令是jmp 0xF000:0xe05b，上电后跳转到该地址执行BIOS代码。
    接下来BIOS会进行一些硬件自检行为，检查通过且初始化好硬件后，开始在0x000～0x3FF中建立数据结构，中断向量表IVT并填写中断例程。
    最后，BIOS会校验启动盘中0盘0道1扇区的内容，如果是是MBR（512字节，最后两字节为0x55、0xaa），将其加载进内存中，通过jmp 0:0x7c00跳转至MBR代码（这时会将cs的值修改成0）。
    
- MBR（主引导记录）
    
- 寄存器
    - 通用寄存器
        - eax 通常用来执行加法，函数调用的返回值一般也放在这里面
        - ebx 数据存取
        - ecx 通常用来作为计数器，比如for循环
        - edx 读写I/O端口时，edx用来存放端口号
        - esp 栈顶指针，指向栈的顶部
        - ebp 栈底指针，指向栈的底部，通常用ebp+偏移量的形式来定位函数存放在栈中的局部变量
        - esi 字符串操作时，用于存放数据源的地址
        - edi 字符串操作时，用于存放目的地址的
    - 段寄存器
        - cs 代码段
        - ds 数据段
        - ss 堆栈段
        - es 扩展段
        - fs 数据段
        - gs 数据段
            - ds ss es fs gs不能用直接数赋值，需要用其他寄存器
    

- 内存访问
    - 代码段 cs:eip
    - 堆栈段 ss:sp
    - 数据段 ds:[直接数/符号地址/寄存器]

    
- 其他
    - $ 本行代码地址
    - $$ 本section的起始地址
    - nasm基本使用
        - nasm -f bin -o mbr.bin mbr.S		纯二进制可执行文件
        - nasm -f elf -o print.o print.S	elf格式二进制可执行文件
    - bios中断手册
    - vstart
        vstart并不是告诉编译器将程序加载到指定地址的内存上，编译器并不具备加载程序到内存的能力。vstart的作用是告诉编译器，后面的以指定的地址作为起始地址来变址。使用vstart的前提是知道程序将会被加载到哪里。
